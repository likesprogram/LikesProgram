# LikesProgram String Format 规范 v0.1

**模块**：`LikesProgram::String`
**文件**：`LikesProgram/String.hpp`
**状态**：正式版（v0.1）
**支持版本**：C++17 及以上

---

## 一、概述

`LikesProgram::String::Format` 是一套跨编码、多类型、安全高效的字符串格式化系统。
其语法基于 `std::format`，融合了 C# 的索引特性与 Python 的灵活性，并在此基础上进行增强：

1. 支持单/多字符填充（可使用 `'...'` 或 `"..."`）；
2. 支持时间格式化扩展（`typeExpand`）；
3. 支持显式索引与自动索引混用的**智能分配规则**；
4. 支持用户注册自定义类型格式化器；
5. 完全兼容 UTF-8 / UTF-16 / UTF-32 / wchar_t。

---

## 二、格式基本语法

```
{[index]:[fill][align][sign][#][0][width][.precision][type][typeExpand]}
```

> 所有字段均为可选；
> 若 `index` 省略，则按参数顺序自动匹配。

---

## 三、语法元素说明

| 元素              | 说明                                                    | 示例                                     | 输出          |
| ------------------ | ----------------------------------------------------- | -------------------------------------- | --------------- |
| `{` `}`            | 占位符边界                                             | `{}`, `{:>10}`                         | 定义参数插入位置 |
| `index` *(可省略)* | 参数索引（从 0 开始）                                   | `{0}`, `{2}`                           | 显式指定参数     |
| `fill`             | 填充字符，可为单个或多字符（用 `'...'` 或 `"..."` 包裹） | `{:'--'<10}`                           | `abc------`     |
| `align`            | 对齐方式：`<` 左、`>` 右、`^` 居中                      | `{:>10}`                               | 右对齐          |
| `sign`             | 数值符号：`+` 正负都显、`-` 仅负显、` ` 正数留空格       | `{:+d}`                                | `+42`           |
| `#`                | 显示进制前缀                                           | `{:#x}`                                | `0xff`          |
| `0`                | 启用零填充                                             | `{:08d}`                               | `00001234`      |
| `width`            | 最小输出宽度                                           | `{:10}`                                | 总宽度 10        |
| `.precision`       | 精度或字符串截断长度                                    | `{:.2f}`, `{:.5s}`                     | 控制数值或长度   |
| `type`             | 数据类型标识                                           | `{:d}`, `{:x}`, `{:f}`, `{:s}`, `{:t}` | 控制格式化类型    |
| `typeExpand`       | 类型扩展说明（主要用于时间）                            | `{:tYYYY-MM-DD}`                       | 时间自定义模板    |

---

## 四、智能索引规则

### 1. 自动索引

若无任何显式索引（如 `{0}`），则所有 `{}` 按参数顺序匹配：

```
String::Format("{} + {} = {}", 1, 2, 3);
// 等价于 {0}{1}{2}
→ "1 + 2 = 3"
```

### 2. 显式索引

可直接指定参数索引：

```
String::Format("{2} + {0} = {1}", 10, 12, 2);
→ "2 + 10 = 12"
```

### 3. 混合索引（智能分配规则）

允许显式与自动混用，系统会自动补齐索引顺序：

| 格式串             | 参数              | 实际映射              | 说明              |
| --------------- | --------------- | ----------------- | ------------------------ |
| `{2}{}{}`       | (A, B, C, D)    | `{2}{0}{1}`       | 显式锚点为 2，剩余按序补齐 |
| `{2}{}{}{}`     | (A, B, C, D, E) | `{2}{0}{1}{3}`    | 自动分配未使用索引         |
| `{2}{}{}{}{}`   | (A, B, C, D, E) | `{2}{0}{1}{3}{4}` | 完全补齐                  |
| `{}` `{2}` `{}` | (A, B, C)       | `{0}{2}{1}`       | 智能跳过已显式索引         |
| `{1}{}{1}{}{}`  | (A, B, C, D, E) | `{1}{0}{1}{2}{3}` | 显式索引可重复使用         |

> 若索引超出参数范围，则输出 `{?}` 占位符。
> 若括号不匹配或格式错误，输出 `{!}`。

实现伪代码：

```cpp
std::unordered_set<int> used;
int autoIndex = 0;

if (hasExplicitIndex) {
    used.insert(explicitIndex);
} else {
    while (used.contains(autoIndex))
        ++autoIndex;
    assignedIndex = autoIndex++;
}
```

---

## 五、类型标识 (`type`)

| 类型        | 含义        | 示例               | 输出             |
| --------- | --------- | ---------------- | -------------- |
| `s`       | 字符串       | `{:s}`           | `"text"`       |
| `d` / `i` | 十进制整数     | `{:d}`           | `"123"`        |
| `x` / `X` | 十六进制      | `{:#06X}`        | `"0X00FF"`     |
| `b`       | 二进制       | `{:#b}`          | `"0b1010"`     |
| `o`       | 八进制       | `{:#o}`          | `"0o77"`       |
| `f`       | 浮点数       | `{:.2f}`         | `"3.14"`       |
| `e` / `E` | 科学计数法     | `{:.3E}`         | `"1.234E+03"`  |
| `%`       | 百分比       | `{:.2%}`         | `"12.34%"`     |
| `t` / `T` | 时间类型（带扩展） | `{:tYYYY-MM-DD}` | `"2025-10-28"` |
| `p`       | 指针地址      | `{:p}`           | `"0x7FFB4A0C"` |
| `u`       | 用户自定义类型   | `{:uVec2}`       | 调用注册格式器        |

---
可以将你的文档替换为与 `FormatTime` 函数实际支持的格式一致的说明如下：

---

## 六、时间格式化扩展 (`typeExpand`)

当 `type` 为 `t` 或 `T` 时，`typeExpand` 解析为时间格式模板，支持两种方式：

### 1. 百分号模板（`%` 开头，类似 `strftime` 风格）

| 占位符           | 含义             | 示例                       |
| ------------- | -------------- | ------------------------ |
| `%Y`          | 四位年份           | 2025                     |
| `%y`          | 两位年份           | 25                       |
| `%m`          | 月（补零）          | 07                       |
| `%d`          | 日（补零）          | 03                       |
| `%H`          | 小时（24h）        | 09                       |
| `%I`          | 小时（12h）        | 09                       |
| `%M`          | 分钟             | 05                       |
| `%S`          | 秒              | 07                       |
| `%f`          | 纳秒（9位）         | 123456789                |
| `%3f/%6f/%9f` | 纳秒缩放（毫秒/微秒/纳秒） | 123 / 123456 / 123456789 |
| `%a`          | 星期简写           | Tue                      |
| `%A`          | 星期全称           | Tuesday                  |
| `%p`          | AM/PM          | PM                       |
| `%z`          | 时区偏移           | +09:00                   |
| `%n`          | 换行符            | \n                       |
| `%t`          | 制表符            | \t                       |
| `%%`          | 百分号            | %                        |

**示例：**

```cpp
auto now = std::chrono::system_clock::now();
FormatTime(now, U"%Y-%m-%d %H:%M:%S");       // → "2025-11-07 22:40:51"
FormatTime(now, U"%Y/%m/%d %H:%M:%S %6f");   // → "2025/11/07 22:40:51 170771"
FormatTime(now, U"%Y/%m/%d %H:%M:%S %f AP"); // → "2025/11/07 22:40:51 170771500 PM"
```

---

### 2. 连续字母模板（自定义占位符）

| 占位符       | 含义       | 示例      |
| --------- | -------- | ------- |
| `YYYY`    | 四位年份     | 2025    |
| `YY`      | 两位年份     | 25      |
| `MM`      | 月（补零）    | 07      |
| `M`       | 月（不补零）   | 7       |
| `DD`      | 日（补零）    | 03      |
| `D`       | 日（不补零）   | 3       |
| `hh`      | 小时（24h）  | 09      |
| `mm`      | 分钟       | 05      |
| `ss`      | 秒        | 07      |
| `SSS`     | 毫秒       | 123     |
| `W`       | 星期数字 1~7 | 5       |
| `WW`      | 星期英文缩写   | Fri     |
| `AP`/`ap` | AM/PM    | PM / am |
| `TZ`      | 时区偏移     | +0800  |

**示例：**

```cpp
auto now = std::chrono::system_clock::now();
FormatTime(now, U"YYYY-MM-DD hh:mm:ss SSS"); // → "2025-11-07 22:40:51 170"
FormatTime(now, U"W WW TZ");                 // → "5 Fri +0800"

// 结合使用
FormatTime(now, U"%Y-M-D %H:%M:%S SSS AP W WW TZ");
// → "2025-11-7 22:53:14 486 PM 5 Fri +0800"
```
---

---

## 七、填充与对齐

支持单个或多个字符填充：

| 示例           | 输出          | 说明    |
| ------------ | ----------- | ----- |
| `{:*>10}`    | `*****abc`  | 右对齐填充 |
| `{:'--'<10}` | `abc------` | 多字符填充 |
| `{:"░"^8}`   | `░abc░░`    | 居中对齐  |

---

## 八、错误与回退机制

| 情况     | 结果        | 说明                       |
| ------ | --------- | ------------------------ |
| 参数不足   | `{?}`     | 安全降级输出                   |
| 格式不闭合  | `{!}`     | 检测不匹配括号                  |
| 未知类型   | `{!type}` | 原样输出                     |
| 时间格式错误 | 自动回退      | 默认 `YYYY-MM-DD hh:mm:ss` |

---

## 九、自定义类型扩展

可注册新的 `u` 类型格式器：

```cpp
String::RegisterFormatter("Vec2", [](const Vec2& v, const String& fmt) {
    return String::Format("({:.2f}, {:.2f})", v.x, v.y);
});

Vec2 v{1.23, 4.56};
String s = String::Format("{:uVec2}", v);
→ "(1.23, 4.56)"
```

---

## 十、内部结构建议

```cpp
struct FormatSpec {
    int index = -1;
    bool explicitIndex = false;

    String fill = U" ";
    char32_t align = U'>';
    bool showBase = false;
    bool zeroPad = false;
    int width = 0;
    int precision = -1;
    char32_t type = U's';
    String typeExpand;
};
```

实现核心分为三阶段：

1. **解析阶段** → 解析 `{}` 内容到 `FormatSpec`
2. **索引分配阶段** → 应用智能索引规则
3. **格式应用阶段** → 调用内建或用户格式化器输出字符串

---

## 十一、兼容性说明

| 特性                  | 支持 | 说明                |
| ------------------- | -- | ----------------- |
| C++20 `std::format` | ✅  | 全兼容               |
| C# `string.Format`  | ✅  | 支持索引语法            |
| Python `format`     | ✅  | 支持自动索引            |
| 多字符填充               | ✅  | `'...'` / `"..."` |
| 时间格式                | ✅  | 自定义模板             |
| 混合索引                | ✅  | 智能补齐算法            |
| 用户扩展                | ✅  | 注册回调              |

---

## 十二、版本历史

| 版本   | 日期         | 变更                       |
| ---- | ---------- | ------------------------ |
| v0.1 | 2025-10-28 | 首个正式版，确立核心语法、索引补全与时间扩展规则 |

---

## 十三、示例集

```cpp
String::Format("Hello, {}!", "World");                     // Hello, World!
String::Format("{1} + {0} = {2}", 2, 3, 5);                // 3 + 2 = 5
String::Format("{:*>8}", 42);                              // ******42
String::Format("{:'填充'<10}", "中");                       // 中填充填充填充
String::Format("{:#08X}", 255);                            // 0X0000FF
String::Format("{:.3f}", 3.14159);                         // 3.142
String::Format("{:tYYYY/MM/DD hh:mm:ss}", now);            // 2025/10/28 03:19:12
String::Format("{2}{}{}{}", 1, 2, 3, 4, 5);                // 3 1 2 4
```
